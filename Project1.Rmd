---
title: "**Project1. Bike Sharing Dataset**"
output: html_document
date: "2023-10-02"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Подключим необходимые пакеты

```{r libraries}
library(dplyr)
library(ggplot2)
library(knitr)
library(heatmaply)
library(plotly)
```
### EDA (Exploratory data analysis)

## Оценим структуру данных

```{r data import}
day <- read.csv("insurance.csv", sep=";")
str(day)
```

В нашем датасете 731 наблюдение по 16 переменным

instant: record index
dteday: date
season: season (1:springer, 2:summer, 3:fall, 4:winter)
yr: year (0: 2011, 1:2012)
mnth: month ( 1 to 12)
holiday: weather day is holiday or not 
weekday: day of the week
workingday: 1:workingday, 0:weekend or holiday.
weathersit: 
1: Clear, Few clouds, Partly cloudy, Partly cloudy
2: Mist + Cloudy, Mist + Broken clouds, Mist + Few clouds, Mist
3: Light Snow, Light Rain + Thunderstorm + Scattered clouds, Light Rain + Scattered clouds
4: Heavy Rain + Ice Pallets + Thunderstorm + Mist, Snow + Fog
temp : Normalized temperature in Celsius. The values are divided to 41 (max)
atemp: Normalized feeling temperature in Celsius. The values are divided to 50 (max)
hum: Normalized humidity. The values are divided to 100 (max)
windspeed: Normalized wind speed. The values are divided to 67 (max)
casual: count of casual users
registered: count of registered users
cnt: count of total rental bikes including both casual and registered

Для переменных dteday, season, yr, holiday, workingday, weathersit неправильно определен тип данных.
Используем базовую функцию summary для оценки данных.

```{r}
summary(day)
sum(is.na(day))
```
Видим, что для показателя hum (влажность) минимальное значение равняется нулю, что явно является выбросом, так как для данного региона такая влажность не характерна. В связи с чем принято решение удалить это наблюдение !!! или поставить NA?.

```{r}
which(day$hum == 0) #удалить это наблюдение !!! или поставить NA?.
```

Видим, что в данных есть пропущенные значения в таких переменных как  temp, hum, windspeed, registered. Всего 9 пропущенных значений.
Посмотрим на конкретные пропущенные значения.

```{r}
which(is.na(day$temp))
which(is.na(day$hum))
which(is.na(day$windspeed))
which(is.na(day$registered))
```

Видим, что для пропущенных значений в переменных temp, hum, windspeed остальные показатели все присутствуют, и они не выглядят аномальными или ошибочными, в связи с чем принято решение не удалять эти наблюдения. Для переменной registered принято решение заменить NA на количество зарегистрированных пользователей, которое можно получить путем вычитания количества casual пользователей из общего числа пользователей в этот день.

```{r}
day$registered[25] <- day$cnt[25] - day$casual[25]
```

На следующем этапе посмотрим на все уникальные значения для тех переменных, которые мы предполагаем, относятся к факторному типу, проверяем, что значения переменных соответствуют ожидаемым (из описания к данным).

```{r}
sort(unique(day$season))
sort(unique(day$yr))
sort(unique(day$mnth))#
sort(unique(day$weekday))#
sort(unique(day$holiday))
sort(unique(day$workingday))
sort(unique(day$weathersit))
```

Видим, что значения переменных соответствуют ожидаемым (из описания к данным). Приведем данные к соотвествующим типам (и присвоем человекочитаемые имена):

```{r}
day$dteday <- as.character.Date(day$dteday) # Даша, вроде ты это сделала уже
day$season <- as.factor(day$season)
day$holiday<- as.factor(day$holiday)
day$workingday <- as.factor(day$workingday) #делаем ли факторной (и месяц)
day$weathersit <- as.factor(day$weathersit)
day$yr #человекочитаемые значения присваиваем
```

Посмотрим на наличие выбросов с помощью боксплотов

```{r}
#Дашины боксплоты
```

Посмотрим на наличие корреляций между числовыми переменными

```{r}
#Создание интерактивной тепловой карты корреляции с p-value 
selected_cols <- c("season", "weathersit", "temp", "hum", "casual", "registered", "cnt")
subset_data <- day[selected_cols]
cor_matrix <- cor(subset_data)

cor.test.p <- function(x){
  FUN <- function(x, y) cor.test(x, y)[["p.value"]]
  z <- outer(
    colnames(x), 
    colnames(x), 
    Vectorize(function(i,j) FUN(x[,i], x[,j]))
  )
  dimnames(z) <- list(colnames(x), colnames(x))
  z
}

p <- cor.test.p(subset_data)

heatmaply_cor(cor_matrix, 
              cellnote = p,
              main = "Heatmap of Bike Sharing Dataset correlation'")
```


Гипотеза 1. Сравнение количества арендованных велосипедов в 2011 и 2012 годах.

Н0: Количество арендованных велосипедов не отличается по годам
Н1: Количество арендованных велосипедов отличается по годам
Уровень значимости - 0.05

Переведем данные из формата numeric в character:
```{r}
day$yr <- ifelse(day$yr == 0, "2011", "2012") 
```
Создадим выборку только из результатов 2011 года и построим гистограмму по cnt:
```{r}
yr11 <- day[day$yr == "2011", ]
hist(yr11$cnt)
```
Создадим выборку только из результатов 2012 года и построим гистограмму по cnt:
```{r}
yr12 <- day[day$yr == "2012", ]
hist(yr12$cnt)
```
Выбранный метод - тест Манна-Уитни, так как у данные по количеству арендованных велосипедов имеют ненормальное распределение по каждому из годов.
Проведем тест:
```{r}
wilcox.test(yr12$cnt, yr11$cnt)
```
Резултат теста показал p-value ниже заданного уровня значимости. Отвергаем Н0.

Построим график, отражающий количество арендованных велосипелов по годам:
```{r}
ggplot(day, aes(yr, cnt, fill = yr)) +
  geom_bar(stat = "identity") +
  labs(title = "Сравнение количества поездок по годам",
       x = "Год",
       y = "Количество арендованных велосипедов (cnt)",
       fill = "Год") +
  theme_minimal()
```
Исходя из графика и результата теста Манна-Уитни можно сделать вывод, что количество арендованных велосипедов возрасло в 2012 году относительно 2011 года.



Гипотеза 2. Проверим влияет ли прогноз погоды на количество арендованных велосипедов.
В наших данных есть три варианта прогноза: 
1: ясно, небольшая облачность, переменная облачность, переменная облачность.
2: Туман + Облачно, Туман + Разрывы облаков, Туман + Мало облаков, Туман
3: Небольшой снег, Небольшой дождь + Гроза + Рассеянные облака, Небольшой дождь + Рассеянные облака

Мы предполагаем, что прогнозирование метеорологами снега, дождя или грозы 
(прогноз зашифрован под цифрой 3) должно существенно снижать колличество арендованных велосипедов.  

Посмотрим на распределение количества арендованных велосипедов в зависимости от прогноза погоды.

```{r}
plot_ly(
  data = day_without_na,
  y = ~cnt,
  x = ~weathersit,
  type = "box"
)
```

На основании полученного граифка действительно можно предположить, что неблагоприятный 
прогноз погоды снижает количество арендованных велосипедов среди общего количеста арендованных велосипедов,
включая как случайных пользователей, так и зарегистрированных.
Давайте посмотрим отдельно на количество арендованных велосипедов случайных (casual) и зарегистрированных (registered) пользователей.

```{r}
# зарегистрированные (registered) пользователи

plot_ly(
  data = day_without_na,
  y = ~registered,
  x = ~weathersit,
  type = "box"
)


# случайные (casual) пользователи
plot_ly(
  data = day_without_na,
  y = ~casual,
  x = ~weathersit,
  type = "box"
) 
```
Таким образом,для проверки гипотезы о том, что прогнозирование метеорологами тумана, облочности, снега, дождя или грозы (прогноз зашифрован под кодами 2 и 3) должно существенно снижать колличество арендованных велосипедов,
необходимо проверить данные на нормальноть распределения c помощью численного  теста Шапиро-Уилка.
Предварительно сформируем две группы для проверки гипотезы, в первую войдут показатели аренды велосипедов
в дни с благоприятным прогнозом погоды без дождя (зашифровано под кодом 1 ), во вторую группу войдут показатели аренды велосипедов в дни с прогнозом погоды с туманом,дождем или снегом (прогноз зашифрован под кодами 2 и 3).

```{r}
weathersit_1 <- filter(day_without_na,weathersit == 1)$cnt
weathersit2_3 <- filter(day_without_na,weathersit == 3 | weathersit == 2)$cnt

shapiro.test(weathersit_1)
shapiro.test(weathersit2_3)

```
1) Определим нулевую гипотезу: величины распределены одинаково и альтернативную - распределение 
величин отличается.
2) Зафиксируем уровень значимости - 0.05
3) Будем использовать статистику критерия - U-критерий Манна — Уитни, так как данные по количеству арендованных велосипедов имеют ненормальное распределение

```{r}
wilcox.test(weathersit_1,weathersit2_3, correct = F)
```
Проверим, наблюдается ли аналогичная зависимость показатели аренды велосипедов для зарегистрированных пользователей и для случайных.



```{r}
# случайные (casual) пользователи
weathersit_1 <- filter(day_without_na,weathersit == 1)$casual
weathersit2_3 <- filter(day_without_na,weathersit == 3 | weathersit == 2)$casual
wilcox.test(weathersit_1,weathersit2_3, correct = F)


# зарегистрированные (registered) пользователи
weathersit_1 <- filter(day_without_na,weathersit == 1)$registered
weathersit2_3 <- filter(day_without_na,weathersit == 3 | weathersit == 2)$registered
wilcox.test(weathersit_1,weathersit2_3, correct = F)

```


### Цитирование


```{r}
knitr::write_bib(c(.packages()), "packages.bib")
```



## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
